<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Geometry Visualizer - CLEAN LOGIC</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; padding: 30px; }
        .input-section { background: #f8f9fa; padding: 25px; border-radius: 10px; height: fit-content; }
        .input-group { margin-bottom: 25px; }
        .input-group h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; }
        .form-row { display: grid; grid-template-columns: 1fr 80px; gap: 10px; margin-bottom: 10px; align-items: center; }
        label { font-weight: 500; color: #495057; }
        input[type="number"] { padding: 8px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 14px; }
        .bike-diagram { background: white; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .test-button { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .measurement-text { font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¥‚Äç‚ôÇÔ∏è Bike Geometry Visualizer</h1>
            <p>Clean logic: Fixed inputs ‚Üí Saddle position ‚Üí Target handlebars ‚Üí Manual components ‚Üí Actual handlebars</p>
        </div>

        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <div class="input-group">
                    <h3>Frame Geometry (mm/degrees)</h3>
                    <div class="form-row"><label>Reach:</label><input type="number" id="reach" placeholder="378"></div>
                    <div class="form-row"><label>Stack:</label><input type="number" id="stack" placeholder="580"></div>
                    <div class="form-row"><label>Seat Tube C-T:</label><input type="number" id="seatTube" placeholder="536"></div>
                    <div class="form-row"><label>Head Angle:</label><input type="number" id="headAngle" placeholder="72.25"></div>
                    <div class="form-row"><label>Seat Angle:</label><input type="number" id="seatAngle" placeholder="73.75"></div>
                    <div class="form-row"><label>Head Tube:</label><input type="number" id="headTube" placeholder="157"></div>
                </div>

                <div class="input-group">
                    <h3>Required Bike Fit (mm)</h3>
                    <div class="form-row"><label>Saddle Height:</label><input type="number" id="saddleHeight" placeholder="760"></div>
                    <div class="form-row"><label>Tip of Saddle to BB:</label><input type="number" id="saddleTipToBB" placeholder="91"></div>
                    <div class="form-row"><label>Saddle to Bar Top Drop:</label><input type="number" id="saddleToBarHeight" placeholder="64"></div>
                    <div class="form-row"><label>Tip of Saddle to Bar Top:</label><input type="number" id="saddleTipToBarCenter" placeholder="550"></div>
                </div>

                <div class="input-group">
                    <h3>Component Options</h3>
                    <div class="form-row"><label>Saddle Length:</label><input type="number" id="saddleLength" value="250" placeholder="250"></div>
                    <div class="form-row"><label>Saddle Rail Position:</label><input type="number" id="saddleRailPosition" value="0" placeholder="0"></div>
                    <div class="form-row"><label>Spacer Height (0-40mm):</label><input type="number" id="spacerHeight" value="20" placeholder="20" min="0" max="40" step="10"></div>
                    <div class="form-row"><label>Stem Length (80-110mm):</label><input type="number" id="stemLength" value="90" placeholder="90" min="80" max="110" step="10"></div>
                    <div class="form-row"><label>Stem Angle (-10¬∞ to +10¬∞):</label><input type="number" id="stemAngle" value="-6" placeholder="-6" min="-10" max="10" step="6"></div>
                </div>

                <div class="validation-section">
                    <h4>Test with 54T Strael</h4>
                    <button class="test-button" onclick="loadStrael54T()">Load Test Data</button>
                    <div id="testResults" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Bike Diagram -->
            <div class="bike-diagram">
                <h3>Bike Geometry Visualization</h3>
                <svg id="bikeSvg" width="1400" height="1000" viewBox="0 0 1400 1000">
                    <!-- Bike frame will be drawn here -->
                </svg>
            </div>
        </div>
    </div>

    <script>
        // === CLEAN BIKE FIT LOGIC ===
        
        function calculateBikeFit() {
            console.log('üîß === CLEAN BIKE FIT CALCULATION ===');
            
            // === STEP 1: FIXED FRAME GEOMETRY ===
            const reach = parseFloat(document.getElementById('reach').value) || 378;
            const stack = parseFloat(document.getElementById('stack').value) || 580;
            const headAngle = parseFloat(document.getElementById('headAngle').value) || 72.25;
            const seatAngle = parseFloat(document.getElementById('seatAngle').value) || 73.75;
            const headTube = parseFloat(document.getElementById('headTube').value) || 157;
            const seatTube = parseFloat(document.getElementById('seatTube').value) || 536;
            const stemStackHeight = 20; // mm - fixed component height
            const handlebarDiameter = 32; // mm - fixed
            
            console.log('üìê Frame:', { reach, stack, headAngle, seatAngle, headTube, seatTube });
            
            // === STEP 2: FIXED BIKE FIT MEASUREMENTS ===
            const saddleHeight = parseFloat(document.getElementById('saddleHeight').value) || 760;
            const saddleLength = parseFloat(document.getElementById('saddleLength').value) || 250;
            const saddleTipToBB = parseFloat(document.getElementById('saddleTipToBB').value) || 91;
            const saddleRailPosition = parseFloat(document.getElementById('saddleRailPosition').value) || 0;
            const saddleToBarHeight = parseFloat(document.getElementById('saddleToBarHeight').value) || 64;
            const saddleTipToBarCenter = parseFloat(document.getElementById('saddleTipToBarCenter').value) || 550;
            
            console.log('üéØ Bike Fit:', { saddleHeight, saddleTipToBB, saddleToBarHeight, saddleTipToBarCenter });
            
            // === STEP 3: CALCULATE SADDLE POSITION ===
            const scale = 1.0, bbX = 400, bbY = 800;
            const seatAngleRad = seatAngle * Math.PI / 180;
            const seatpostLength = saddleHeight - seatTube;
            
            // Seatpost shaft top (no setback yet)
            const shaftTopX = bbX - ((seatTube + seatpostLength) * scale) * Math.cos(seatAngleRad);
            const shaftTopY = bbY - ((seatTube + seatpostLength) * scale) * Math.sin(seatAngleRad);
            
            // Required setback to achieve target tip-to-BB
            const targetTipX = bbX - (saddleTipToBB * scale); // Convert mm to pixels
            const requiredSetback = (shaftTopX + (saddleLength/2 * scale) + (saddleRailPosition * scale) - targetTipX) / scale; // Convert result back to mm
            
            console.log('üìè Setback calculation: Required setback =', Math.round(requiredSetback), 'mm');
            
            // Final saddle position
            const seatpostHeadX = shaftTopX - (requiredSetback * scale); // Convert mm back to pixels for positioning
            const seatpostHeadY = shaftTopY;
            const saddleCenterX = seatpostHeadX + (saddleRailPosition * scale); // Convert mm to pixels
            const saddleCenterY = seatpostHeadY;
            const saddleTipX = saddleCenterX + ((saddleLength/2) * scale); // Convert mm to pixels
            const saddleTipY = saddleCenterY;
            
            console.log('ü™ë Saddle tip at:', Math.round(saddleTipX), Math.round(saddleTipY), '| Distance from BB:', Math.round((bbX - saddleTipX) / scale), 'mm');
            
            // === STEP 4: CALCULATE TARGET HANDLEBAR POSITION ===
            // Bike fit measurements are to the TOP of the handlebar, not center
            const horizontalDistance = Math.sqrt(Math.pow(saddleTipToBarCenter, 2) - Math.pow(saddleToBarHeight, 2));
            const targetBarTopX = saddleTipX + (horizontalDistance * scale); // Convert mm to pixels
            const targetBarTopY = saddleTipY + (saddleToBarHeight * scale); // Convert mm to pixels
            
            // Derive handlebar center from top position
            const targetBarX = targetBarTopX;
            const targetBarY = targetBarTopY + ((handlebarDiameter/2) * scale); // Convert mm to pixels
            
            console.log('üéØ TARGET handlebar top at:', Math.round(targetBarTopX), Math.round(targetBarTopY));
            
            // Verify bike fit measurements
            const actualTipToBarDistance = Math.sqrt(Math.pow(targetBarTopX - saddleTipX, 2) + Math.pow(targetBarTopY - saddleTipY, 2)) / scale; // Convert pixels to mm
            const actualSaddleToBarDrop = (targetBarTopY - saddleTipY) / scale; // Convert pixels to mm
            console.log('‚úÖ Verification - Tip to bar:', Math.round(actualTipToBarDistance), 'mm vs target:', saddleTipToBarCenter, 'mm');
            console.log('‚úÖ Verification - Saddle drop:', Math.round(actualSaddleToBarDrop), 'mm vs target:', saddleToBarHeight, 'mm');
            
            // === STEP 5: MANUAL COMPONENT SELECTION ===
            const spacerHeight = parseFloat(document.getElementById('spacerHeight').value) || 20;
            const stemLength = parseFloat(document.getElementById('stemLength').value) || 90;
            const stemAngle = parseFloat(document.getElementById('stemAngle').value) || -6;
            
            console.log('üîß COMPONENTS Selected:', { spacerHeight, stemLength, stemAngle });
            console.log('üí° Try different values: Spacers 0-40mm (¬±10mm), Stem 80-110mm (¬±10mm), Angle -10¬∞ to +10¬∞');
            
            // === STEP 6: CALCULATE ACTUAL HANDLEBAR POSITION ===
            const headAngleRad = headAngle * Math.PI / 180;
            const headTubeTopX = bbX + reach;
            const headTubeTopY = bbY - stack;
            
            const spacerTopX = headTubeTopX - (spacerHeight * scale) * Math.cos(headAngleRad);
            const spacerTopY = headTubeTopY - (spacerHeight * scale) * Math.sin(headAngleRad);
            
            const stemBodyTopX = spacerTopX - (stemStackHeight * scale) * Math.cos(headAngleRad);
            const stemBodyTopY = spacerTopY - (stemStackHeight * scale) * Math.sin(headAngleRad);
            
            const stemAngleRad = (headAngle - 90 - stemAngle) * (Math.PI / 180);
            const actualBarX = stemBodyTopX + (stemLength * scale) * Math.cos(stemAngleRad);
            const actualBarY = stemBodyTopY + (stemLength * scale) * Math.sin(stemAngleRad);
            const actualBarTopY = actualBarY - (handlebarDiameter/2);
            
            console.log('üîß ACTUAL handlebar top at:', Math.round(actualBarX), Math.round(actualBarTopY));
            console.log('üìä Difference: X =', Math.round(actualBarX - targetBarTopX), 'Y =', Math.round(actualBarTopY - targetBarTopY));
            
            // Calculate actual fit achieved with selected components
            const actualFitDrop = actualBarTopY - saddleTipY;
            const actualFitTipToBar = Math.sqrt(Math.pow(actualBarX - saddleTipX, 2) + Math.pow(actualBarTopY - saddleTipY, 2));
            const dropError = Math.abs(actualFitDrop - saddleToBarHeight);
            const tipToBarError = Math.abs(actualFitTipToBar - saddleTipToBarCenter);
            
            console.log('üéØ FIT ACHIEVED with your components:');
            console.log('   Drop:', Math.round(actualFitDrop), 'mm (target:', saddleToBarHeight, 'mm, error:', Math.round(dropError), 'mm)');
            console.log('   Tip-to-Bar:', Math.round(actualFitTipToBar), 'mm (target:', saddleTipToBarCenter, 'mm, error:', Math.round(tipToBarError), 'mm)');
            console.log('üí° Adjust components to minimize errors!');
            
            // === STEP 7: DRAW EVERYTHING ===
            drawBikeDiagram({
                // Frame
                reach, stack, headAngle, seatAngle, headTube, seatTube,
                // Saddle
                saddleHeight, saddleLength, saddleTipToBB, saddleRailPosition,
                saddleCenterX, saddleCenterY, saddleTipX, saddleTipY,
                // Target handlebars
                targetBarX, targetBarY, targetBarTopX, targetBarTopY,
                // Actual handlebars
                actualBarX, actualBarY, actualBarTopY,
                // Components
                spacerHeight, stemLength, stemAngle, stemStackHeight, handlebarDiameter,
                // Calculated setback and seatpost shaft position
                requiredSetback, shaftTopX, shaftTopY
            });
        }
        
        function drawBikeDiagram(params) {
            const svg = document.getElementById('bikeSvg');
            const scale = 1.0;
            const bbX = 400, bbY = 800;
            
            // Clear previous drawing
            svg.innerHTML = '';
            
            // Frame angles
            const seatAngleRad = params.seatAngle * Math.PI / 180;
            const headAngleRad = params.headAngle * Math.PI / 180;
            
            // Key points
            const headTubeTopX = bbX + params.reach;
            const headTubeTopY = bbY - params.stack;
            const seatTubeTopX = bbX - (params.seatTube * Math.cos(seatAngleRad));
            const seatTubeTopY = bbY - (params.seatTube * Math.sin(seatAngleRad));
            
            // 1. Draw Bottom Bracket
            const bbCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bbCircle.setAttribute('cx', bbX);
            bbCircle.setAttribute('cy', bbY);
            bbCircle.setAttribute('r', 8);
            bbCircle.setAttribute('fill', '#e74c3c');
            svg.appendChild(bbCircle);
            
            // 2. Draw frame triangle
            const seatTube = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatTube.setAttribute('x1', bbX);
            seatTube.setAttribute('y1', bbY);
            seatTube.setAttribute('x2', seatTubeTopX);
            seatTube.setAttribute('y2', seatTubeTopY);
            seatTube.setAttribute('stroke', '#34495e');
            seatTube.setAttribute('stroke-width', '6');
            svg.appendChild(seatTube);
            
            const headTubeBottomX = headTubeTopX + (params.headTube * Math.cos(headAngleRad));
            const headTubeBottomY = headTubeTopY + (params.headTube * Math.sin(headAngleRad));
            
            const headTube = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            headTube.setAttribute('x1', headTubeTopX);
            headTube.setAttribute('y1', headTubeTopY);
            headTube.setAttribute('x2', headTubeBottomX);
            headTube.setAttribute('y2', headTubeBottomY);
            headTube.setAttribute('stroke', '#34495e');
            headTube.setAttribute('stroke-width', '6');
            svg.appendChild(headTube);
            
            const topTube = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            topTube.setAttribute('x1', seatTubeTopX);
            topTube.setAttribute('y1', seatTubeTopY);
            topTube.setAttribute('x2', headTubeTopX);
            topTube.setAttribute('y2', headTubeTopY);
            topTube.setAttribute('stroke', '#34495e');
            topTube.setAttribute('stroke-width', '6');
            svg.appendChild(topTube);
            
            // 3. Draw saddle
            const saddleLeftX = params.saddleCenterX - (params.saddleLength/2);
            const saddleRightX = params.saddleCenterX + (params.saddleLength/2);
            
            const saddle = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            saddle.setAttribute('x1', saddleLeftX);
            saddle.setAttribute('y1', params.saddleCenterY);
            saddle.setAttribute('x2', saddleRightX);
            saddle.setAttribute('y2', params.saddleCenterY);
            saddle.setAttribute('stroke', '#8e44ad');
            saddle.setAttribute('stroke-width', '6');
            svg.appendChild(saddle);
            
            // 4. Draw TARGET handlebars (green)
            const targetBar = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            targetBar.setAttribute('cx', params.targetBarX);
            targetBar.setAttribute('cy', params.targetBarY);
            targetBar.setAttribute('r', params.handlebarDiameter/2);
            targetBar.setAttribute('fill', 'none');
            targetBar.setAttribute('stroke', '#27ae60');
            targetBar.setAttribute('stroke-width', '3');
            targetBar.setAttribute('stroke-dasharray', '5,5');
            svg.appendChild(targetBar);
            
            // 5. Draw stem components
            // Note: headAngleRad already declared above
            
            // Spacers (orange line extending from head tube top)
            const spacerTopX = headTubeTopX - (params.spacerHeight * Math.cos(headAngleRad));
            const spacerTopY = headTubeTopY - (params.spacerHeight * Math.sin(headAngleRad));
            
            const spacers = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            spacers.setAttribute('x1', headTubeTopX);
            spacers.setAttribute('y1', headTubeTopY);
            spacers.setAttribute('x2', spacerTopX);
            spacers.setAttribute('y2', spacerTopY);
            spacers.setAttribute('stroke', '#f39c12');
            spacers.setAttribute('stroke-width', '6');
            spacers.setAttribute('stroke-linecap', 'round');
            svg.appendChild(spacers);
            
            // Stem stack height (gray line - the 20mm component)
            const stemBodyTopX = spacerTopX - (params.stemStackHeight * Math.cos(headAngleRad));
            const stemBodyTopY = spacerTopY - (params.stemStackHeight * Math.sin(headAngleRad));
            
            const stemStackElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stemStackElement.setAttribute('x1', spacerTopX);
            stemStackElement.setAttribute('y1', spacerTopY);
            stemStackElement.setAttribute('x2', stemBodyTopX);
            stemStackElement.setAttribute('y2', stemBodyTopY);
            stemStackElement.setAttribute('stroke', '#2c3e50');
            stemStackElement.setAttribute('stroke-width', '4');
            stemStackElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(stemStackElement);
            
            // Stem (gray line - forward extension)
            const stemAngleRad = (params.headAngle - 90 - params.stemAngle) * (Math.PI / 180);
            const stemEndX = stemBodyTopX + (params.stemLength * Math.cos(stemAngleRad));
            const stemEndY = stemBodyTopY + (params.stemLength * Math.sin(stemAngleRad));
            
            const stemElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stemElement.setAttribute('x1', stemBodyTopX);
            stemElement.setAttribute('y1', stemBodyTopY);
            stemElement.setAttribute('x2', stemEndX);
            stemElement.setAttribute('y2', stemEndY);
            stemElement.setAttribute('stroke', '#2c3e50');
            stemElement.setAttribute('stroke-width', '4');
            stemElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(stemElement);
            
            // 6. Draw ACTUAL handlebars (teal) - positioned at stem end
            const actualBar = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            actualBar.setAttribute('cx', stemEndX);
            actualBar.setAttribute('cy', stemEndY);
            actualBar.setAttribute('r', params.handlebarDiameter/2);
            actualBar.setAttribute('fill', '#16a085');
            actualBar.setAttribute('stroke', '#138d75');
            actualBar.setAttribute('stroke-width', '2');
            svg.appendChild(actualBar);
            
            // 7. Draw seatpost height line (dotted line from seat tube top to seatpost shaft top - fixed position)
            const seatpostHeightLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatpostHeightLine.setAttribute('x1', seatTubeTopX);
            seatpostHeightLine.setAttribute('y1', seatTubeTopY);
            seatpostHeightLine.setAttribute('x2', params.shaftTopX);
            seatpostHeightLine.setAttribute('y2', params.shaftTopY);
            seatpostHeightLine.setAttribute('stroke', '#95a5a6');
            seatpostHeightLine.setAttribute('stroke-width', '2');
            seatpostHeightLine.setAttribute('stroke-dasharray', '4,4');
            svg.appendChild(seatpostHeightLine);
            
            // 8. Draw setback line (horizontal offset from seatpost shaft to saddle center)
            if (Math.abs(params.requiredSetback) > 1) { // Only draw if there's meaningful setback
                const setbackLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                setbackLine.setAttribute('x1', params.shaftTopX);
                setbackLine.setAttribute('y1', params.shaftTopY);
                setbackLine.setAttribute('x2', params.saddleCenterX);
                setbackLine.setAttribute('y2', params.saddleCenterY);
                setbackLine.setAttribute('stroke', '#f39c12');
                setbackLine.setAttribute('stroke-width', '3');
                setbackLine.setAttribute('stroke-dasharray', '2,2');
                svg.appendChild(setbackLine);
            }
            
            // 9. Display actual horizontal setback (passed from calculation)
            const setbackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            setbackText.setAttribute('x', 1050);
            setbackText.setAttribute('y', 50);
            setbackText.setAttribute('class', 'measurement-text');
            setbackText.setAttribute('font-size', '14px');
            setbackText.setAttribute('fill', '#2c3e50');
            setbackText.setAttribute('font-weight', 'bold');
            setbackText.setAttribute('text-anchor', 'start');
            setbackText.textContent = `Seatpost Setback: ${Math.round(params.requiredSetback)}mm`;
            svg.appendChild(setbackText);
            
            // 10. Calculate and display handlebar position differences (center to center)
            const xDifference = Math.round((stemEndX - params.targetBarX) / scale);
            const yDifference = Math.round((stemEndY - params.targetBarY) / scale);
            const differenceText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            differenceText.setAttribute('x', 1050);
            differenceText.setAttribute('y', 75);
            differenceText.setAttribute('class', 'measurement-text');
            differenceText.setAttribute('font-size', '14px');
            differenceText.setAttribute('fill', '#e74c3c');
            differenceText.setAttribute('font-weight', 'bold');
            differenceText.setAttribute('text-anchor', 'start');
            differenceText.textContent = `Bar Position Difference: X ${xDifference > 0 ? '+' : ''}${xDifference}mm, Y ${yDifference > 0 ? '+' : ''}${yDifference}mm`;
            svg.appendChild(differenceText);
        }
        
        window.loadStrael54T = function() {

            
            // Frame geometry
            document.getElementById('reach').value = 378;
            document.getElementById('stack').value = 580;
            document.getElementById('seatTube').value = 536;
            document.getElementById('headAngle').value = 72.25;
            document.getElementById('seatAngle').value = 73.75;
            document.getElementById('headTube').value = 157;

            // Bike fit (optimal values)  
            document.getElementById('saddleHeight').value = 760;
            document.getElementById('saddleTipToBB').value = 91;
            document.getElementById('saddleToBarHeight').value = 64;
            document.getElementById('saddleTipToBarCenter').value = 550;

            // Component configuration (based on bike fitter recommendation: ~90mm stem)
            document.getElementById('spacerHeight').value = 20;
            document.getElementById('stemLength').value = 90;
            document.getElementById('stemAngle').value = -6;

            // Calculate and draw
            calculateBikeFit();
            
            document.getElementById('testResults').innerHTML = '‚úÖ Test data loaded!';
        };
        
        // Auto-calculate on input changes
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculateBikeFit);
            });
        });
        
        // Test that script is loading
        console.log('üîß Script loaded successfully!');
        console.log('üîß loadStrael54T function defined:', typeof window.loadStrael54T);
    </script>
</body>
</html>