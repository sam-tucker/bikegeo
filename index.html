<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Fit Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            height: fit-content;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }

        .form-row label {
            font-weight: 500;
            color: #2c3e50;
        }

        .form-row input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-row input:focus {
            outline: none;
            border-color: #3498db;
        }

        .bike-diagram {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .bike-diagram h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            height: fit-content;
        }

        .results-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 5px;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }

        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #27ae60;
        }

        .result-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .validation-section {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .validation-section h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .test-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .test-button:hover {
            background: #2980b9;
        }

        .warning {
            color: #e74c3c;
            font-weight: bold;
        }

        .success {
            color: #27ae60;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .measurement-line {
            stroke: #e74c3c;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        .measurement-text {
            font-family: Arial, sans-serif;
            font-size: 12px;
            fill: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¥‚Äç‚ôÇÔ∏è Bike Fit Calculator</h1>
            <p>Calculate seatpost setback, stem length/angle, and spacer height based on frame geometry and fit requirements</p>
        </div>

        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <div class="input-group">
                    <h3>Frame Geometry (mm/degrees)</h3>
                    <div class="form-row">
                        <label for="reach">Reach:</label>
                        <input type="number" id="reach" step="0.1" placeholder="378">
                    </div>
                    <div class="form-row">
                        <label for="stack">Stack:</label>
                        <input type="number" id="stack" step="0.1" placeholder="580">
                    </div>
                    <div class="form-row">
                        <label for="seatTube">Seat Tube C-T:</label>
                        <input type="number" id="seatTube" step="0.1" placeholder="536">
                    </div>
                    <div class="form-row">
                        <label for="headAngle">Head Angle:</label>
                        <input type="number" id="headAngle" step="0.1" placeholder="72.25">
                    </div>
                    <div class="form-row">
                        <label for="seatAngle">Seat Angle:</label>
                        <input type="number" id="seatAngle" step="0.1" placeholder="73.75">
                    </div>
                    <div class="form-row">
                        <label for="headTube">Head Tube:</label>
                        <input type="number" id="headTube" step="0.1" placeholder="157">
                    </div>
                </div>

                <div class="input-group">
                    <h3>Required Bike Fit (mm)</h3>
                    <div class="form-row">
                        <label for="saddleHeight">Saddle Height:</label>
                        <input type="number" id="saddleHeight" step="0.1" placeholder="760">
                    </div>
                    <div class="form-row">
                        <label for="saddleTipToBB">Tip of Saddle to BB:</label>
                        <input type="number" id="saddleTipToBB" step="0.1" placeholder="91">
                    </div>
                    <div class="form-row">
                        <label for="saddleToBarHeight">Saddle to Bar Height Diff:</label>
                        <input type="number" id="saddleToBarHeight" step="0.1" placeholder="64">
                    </div>
                    <div class="form-row">
                        <label for="saddleTipToBarCenter">Tip of Saddle to Bar Center:</label>
                        <input type="number" id="saddleTipToBarCenter" step="0.1" placeholder="550">
                    </div>
                </div>

                <div class="input-group">
                    <h3>Component Options</h3>
                    <div class="form-row">
                        <label for="saddleLength">Saddle Length:</label>
                        <input type="number" id="saddleLength" step="0.1" value="250" placeholder="250">
                    </div>
                    <div class="form-row">
                        <label for="stemAngle">Stem Angle:</label>
                        <input type="number" id="stemAngle" step="1" value="-6" placeholder="-6">
                    </div>
                    <div class="form-row">
                        <label for="saddleRailPosition">Saddle Rail Position:</label>
                        <input type="number" id="saddleRailPosition" step="1" value="0" placeholder="0" title="mm fore(+) or aft(-) from center">
                    </div>
                </div>

                <div class="validation-section">
                    <h4>Test with 54T Strael</h4>
                    <button class="test-button" onclick="loadStrael54T()">Load Test Data</button>
                    <div id="testResults" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- Bike Diagram -->
            <div class="bike-diagram">
                <h3>Bike Geometry Visualization</h3>
                <svg id="bikeSvg" width="800" height="600" viewBox="0 0 800 600">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="currentColor" />
                        </marker>
                    </defs>
                    <!-- Bike frame will be drawn here -->
                </svg>
            </div>

            <!-- Results Section -->
            <div class="results-section">
                <h3>üîß Component Recommendations</h3>
                
                <div class="result-item">
                    <h4>Seatpost Setback</h4>
                    <div class="result-value" id="seatpostSetback">-- mm</div>
                    <div class="result-status" id="seatpostStatus">Enter measurements</div>
                </div>

                <div class="result-item">
                    <h4>Stem Length</h4>
                    <div class="result-value" id="stemLength">-- mm</div>
                    <div class="result-status" id="stemStatus">Enter measurements</div>
                </div>

                <div class="result-item">
                    <h4>Headset Spacers</h4>
                    <div class="result-value" id="spacerHeight">-- mm</div>
                    <div class="result-status" id="spacerStatus">Enter measurements</div>
                </div>



                <div class="input-group" style="margin-top: 30px;">
                    <h3>üìã Shopping List</h3>
                    <div id="shoppingList" style="background: white; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        Enter measurements to generate component list
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function findOptimalStemConfig(headTubeTopX, headTubeTopY, headAngle, targetBarX, targetBarY, scale) {
            // Standard component options
            const spacerOptions = [0, 10, 20, 30, 40]; // mm
            const stemLengthOptions = [80, 90, 100, 110]; // mm  
            const stemAngleOptions = [10, 6, 0, -6, -10]; // degrees
            const stemHeight = 40; // mm - constant
            
            const headAngleRad = headAngle * (Math.PI / 180);
            let allConfigs = [];
            
            // Try every combination
            for (let spacers of spacerOptions) {
                for (let stemLength of stemLengthOptions) {
                    for (let stemAngle of stemAngleOptions) {
                        
                        // Calculate actual handlebar position with this config
                        
                        // 1. Spacer position
                        const spacerTopX = headTubeTopX - (spacers * scale) * Math.cos(headAngleRad);
                        const spacerTopY = headTubeTopY - (spacers * scale) * Math.sin(headAngleRad);
                        
                        // 2. Stem height position  
                        const stemBodyTopX = spacerTopX - (stemHeight * scale) * Math.cos(headAngleRad);
                        const stemBodyTopY = spacerTopY - (stemHeight * scale) * Math.sin(headAngleRad);
                        
                        // 3. Stem extension
                        const stemAngleRad = (headAngle - 90 - stemAngle) * (Math.PI / 180);
                        const actualBarX = stemBodyTopX + (stemLength * scale) * Math.cos(stemAngleRad);
                        const actualBarY = stemBodyTopY + (stemLength * scale) * Math.sin(stemAngleRad);
                        
                        // Calculate error distance from target (convert back to mm)
                        const errorX = (actualBarX - targetBarX) / scale;
                        const errorY = (actualBarY - targetBarY) / scale;
                        const error = Math.sqrt(errorX * errorX + errorY * errorY);
                        
                        allConfigs.push({
                            spacers, stemLength, stemAngle, error,
                            actualX: actualBarX, actualY: actualBarY,
                            errorX: Math.round(errorX * 10) / 10,
                            errorY: Math.round(errorY * 10) / 10
                        });
                    }
                }
            }
            
            // Return top 3 closest matches
            return allConfigs.sort((a, b) => a.error - b.error).slice(0, 3);
        }

        // Simplified frame geometry visualization
        function calculateBikeFit() {
            // Get frame geometry values
            const reach = parseFloat(document.getElementById('reach').value) || 378;
            const stack = parseFloat(document.getElementById('stack').value) || 580;
            const headAngle = parseFloat(document.getElementById('headAngle').value) || 72.25;
            const seatAngle = parseFloat(document.getElementById('seatAngle').value) || 73.75;
            const headTube = parseFloat(document.getElementById('headTube').value) || 157;
            const seatTube = parseFloat(document.getElementById('seatTube').value) || 536;
            const bbDrop = 72; // Fixed value since not needed for bike fit calculations
            
            // Get bike fit values
            const saddleHeight = parseFloat(document.getElementById('saddleHeight').value) || 760;
            const saddleLength = parseFloat(document.getElementById('saddleLength').value) || 250;
            const saddleTipToBB = parseFloat(document.getElementById('saddleTipToBB').value) || 91;
            const saddleRailPosition = parseFloat(document.getElementById('saddleRailPosition').value) || 0;
            const saddleToBarHeight = parseFloat(document.getElementById('saddleToBarHeight').value) || 64;
            const saddleTipToBarCenter = parseFloat(document.getElementById('saddleTipToBarCenter').value) || 550;
            
            // === SEATPOST SETBACK CALCULATION ===
            // Calculate required seatpost setback to achieve target tip-to-BB distance
            
            // Convert angles to radians
            const seatAngleRad = (seatAngle * Math.PI) / 180;
            
            // Calculate seatpost top position (no setback yet)
            const seatpostTopX_noSetback = -saddleHeight * Math.cos(seatAngleRad); // Relative to BB
            const seatpostTopY_noSetback = -saddleHeight * Math.sin(seatAngleRad); // Relative to BB
            
            // Calculate saddle tip position with no setback (tip is forward of attachment point)
            const saddleTipX_noSetback = seatpostTopX_noSetback + (saddleLength / 2) + saddleRailPosition;
            
            // Calculate current HORIZONTAL tip-to-BB distance (matching visualization)
            const currentHorizontalTipToBB = Math.abs(saddleTipX_noSetback);
            
            // Calculate setback needed (setback moves saddle backwards horizontally)
            // Positive setback reduces the horizontal distance to BB
            const requiredSetback = currentHorizontalTipToBB - saddleTipToBB;
            
            // Constrain setback to reasonable range (0-30mm)
            const seatpostSetback = Math.max(0, Math.min(30, requiredSetback));

            // === STEM OPTIMIZATION ===
            
            // Calculate target handlebar position from fit requirements
            const scale = 0.6; // Same scale as diagram
            const offsetX = 100;
            const offsetY = 100;
            const bbX = offsetX + 200;
            const bbY = offsetY + 450;
            
            // Head tube top position (for optimization calculation)
            const headTubeTopX = bbX + (reach * scale);
            const headTubeTopY = bbY - (stack * scale);
            
            // Saddle tip position (from seatpost + setback calculation)
            const saddleCenterX = bbX - (saddleHeight * Math.cos(seatAngleRad) * scale) + (seatpostSetback * scale);
            const saddleTipX = saddleCenterX + ((saddleLength / 2 + saddleRailPosition) * scale);
            const saddleTipY = bbY - (saddleHeight * scale);
            
            // Target handlebar position from fit requirements
            const horizontalDistance = Math.sqrt((saddleTipToBarCenter * saddleTipToBarCenter) - (saddleToBarHeight * saddleToBarHeight));
            const targetBarX = saddleTipX + (horizontalDistance * scale);
            const targetBarY = saddleTipY + (saddleToBarHeight * scale);
            
            // Find optimal stem configuration
            const stemOptions = findOptimalStemConfig(headTubeTopX, headTubeTopY, headAngle, targetBarX, targetBarY, scale);
            
            // Use best option
            const bestConfig = stemOptions[0];
            const spacerHeight = bestConfig.spacers;
            const stemLength = bestConfig.stemLength;
            const stemAngle = bestConfig.stemAngle;

            // Update results with calculated values
            updateResults({
                seatpostSetback: Math.round(seatpostSetback * 10) / 10,
                stemLength: stemLength,
                spacerHeight: spacerHeight,
                stemAngle: stemAngle,
                stemOptions: stemOptions
            });

            // Draw the bike frame with actual geometry and fit data
            drawBikeDiagram({
                reach, stack, headAngle, seatAngle, headTube, seatTube, bbDrop,
                saddleHeight, saddleLength, seatpostSetback, saddleTipToBB, saddleRailPosition, saddleToBarHeight, saddleTipToBarCenter, spacerHeight, stemLength, stemAngle
            });
        }

        function updateResults(results) {
            // Seatpost setback
            document.getElementById('seatpostSetback').textContent = results.seatpostSetback + ' mm';
            const seatpostStatus = document.getElementById('seatpostStatus');
            if (results.seatpostSetback < 20) {
                seatpostStatus.innerHTML = '<span class="warning">‚ö†Ô∏è Below recommended range (20-30mm)</span>';
            } else if (results.seatpostSetback > 30) {
                seatpostStatus.innerHTML = '<span class="warning">‚ö†Ô∏è Above recommended range (20-30mm)</span>';
            } else {
                seatpostStatus.innerHTML = '<span class="success">‚úÖ Within recommended range</span>';
            }

            // Stem length
            document.getElementById('stemLength').textContent = Math.round(results.stemLength) + ' mm';
            const stemStatus = document.getElementById('stemStatus');
            const stemLengthRounded = Math.round(results.stemLength);
            if (stemLengthRounded < 80) {
                stemStatus.innerHTML = '<span class="warning">‚ö†Ô∏è Below recommended range (80-110mm)</span>';
            } else if (stemLengthRounded > 110) {
                stemStatus.innerHTML = '<span class="warning">‚ö†Ô∏è Above recommended range (80-110mm)</span>';
            } else {
                stemStatus.innerHTML = '<span class="success">‚úÖ Within recommended range</span>';
            }

            // Spacer height
            document.getElementById('spacerHeight').textContent = results.spacerHeight + ' mm';
            const spacerStatus = document.getElementById('spacerStatus');
            if (results.spacerHeight > 40) {
                spacerStatus.innerHTML = '<span class="warning">‚ö†Ô∏è Above maximum (40mm)</span>';
            } else {
                spacerStatus.innerHTML = '<span class="success">‚úÖ Within limits</span>';
            }



            // Update shopping list
            updateShoppingList(results);
        }

        function updateShoppingList(results) {
            let shoppingList = `
                <strong>üéØ OPTIMIZED STEM CONFIGURATION!</strong><br><br>
                üìè <strong>Reach:</strong> ${document.getElementById('reach').value}mm<br>
                üìê <strong>Stack:</strong> ${document.getElementById('stack').value}mm<br>
                ü™ë <strong>Seat Angle:</strong> ${document.getElementById('seatAngle').value}¬∞<br>
                üìè <strong>Seat Tube C-T:</strong> ${document.getElementById('seatTube').value}mm<br>
                üîß <strong>Head Angle:</strong> ${document.getElementById('headAngle').value}¬∞<br>
                üìè <strong>Head Tube:</strong> ${document.getElementById('headTube').value}mm<br>
                üèçÔ∏è <strong>Saddle Height:</strong> ${document.getElementById('saddleHeight').value}mm<br>
                üìè <strong>Saddle Length:</strong> ${document.getElementById('saddleLength').value}mm<br>
                üéØ <strong>Target Tip-to-BB:</strong> ${document.getElementById('saddleTipToBB').value}mm<br>
                üìê <strong>Saddle-Bar Drop:</strong> ${document.getElementById('saddleToBarHeight').value}mm<br>
                üìè <strong>Tip-to-Bar Center:</strong> ${document.getElementById('saddleTipToBarCenter').value}mm<br><br>
                
                <strong>üèÜ OPTIMIZED COMPONENTS:</strong><br>
                üîß <strong>Spacers:</strong> ${results.spacerHeight}mm<br>
                üîß <strong>Stem Height:</strong> 40mm (constant)<br>
                üîß <strong>Stem Length:</strong> ${results.stemLength}mm<br>
                üìê <strong>Stem Angle:</strong> ${results.stemAngle}¬∞ from ‚ä•<br>
            `;
            
            // Add alternative options if available
            if (results.stemOptions && results.stemOptions.length > 1) {
                shoppingList += `<br><strong>üìã ALTERNATIVES:</strong><br>`;
                for (let i = 1; i < Math.min(3, results.stemOptions.length); i++) {
                    const option = results.stemOptions[i];
                    shoppingList += `${i + 1}. ${option.spacers}mm spacers + ${option.stemLength}mm stem + ${option.stemAngle}¬∞ (${Math.round(option.error * 10) / 10}mm error)<br>`;
                }
            }
            
            shoppingList += `<br>
                <strong>‚úÖ What you should see:</strong><br>
                ‚Ä¢ Red BB center point<br>
                ‚Ä¢ Blue head tube top point<br>
                ‚Ä¢ Red reach & blue stack lines<br>
                ‚Ä¢ Dark gray frame triangle<br>
                ‚Ä¢ Dark seatpost (shaft + setback head)<br>
                ‚Ä¢ Purple saddle with red tip marker<br>
                ‚Ä¢ Teal handlebar circle (positioned by optimization)<br>
                ‚Ä¢ Orange spacers (optimized distance)<br>
                ‚Ä¢ Dark gray stem height (constant 40mm component)<br>
                ‚Ä¢ Dark gray stem (optimized length & angle)<br>
                ‚Ä¢ Orange saddle height (straight up seatpost)<br>
                ‚Ä¢ Red tip-to-BB (horizontal measurement)<br>
                ‚Ä¢ Purple saddle drop measurement<br>
                ‚Ä¢ Green tip-to-bar diagonal measurement<br>
                ‚Ä¢ All measurement labels<br><br>
                <em>Components optimized for perfect fit! üö¥‚Äç‚ôÇÔ∏è</em>
            `;
            document.getElementById('shoppingList').innerHTML = shoppingList;
        }

        function drawBikeDiagram(params) {
            const svg = document.getElementById('bikeSvg');
            const scale = 0.6; // Adjusted scale to fit better
            const offsetX = 100;
            const offsetY = 100;
            
            // Clear previous drawing
            svg.innerHTML = svg.querySelector('defs').outerHTML;

            // Bottom bracket is our origin point - positioned to allow space for measurements
            const bbX = offsetX + 200;
            const bbY = offsetY + 450; // More space above for stack measurement

            // Frame geometry values
            const reach = params.reach || 378;
            const stack = params.stack || 580;
            const seatAngle = params.seatAngle || 73.75;
            const seatTube = params.seatTube || 536;
            const headAngle = params.headAngle || 72.25;
            const headTube = params.headTube || 157;


            // Head tube top position (scaled) - still needed for measurements
            const headTubeTopX = bbX + (reach * scale);
            const headTubeTopY = bbY - (stack * scale);

            // Calculate seat tube top position
            // Seat angle is measured from horizontal, seat tube leans back slightly  
            const seatAngleRad = (seatAngle * Math.PI) / 180;
            const seatTubeCTLength = seatTube * scale; // Use actual C-T measurement scaled
            const seatTubeTopX = bbX - (seatTubeCTLength) * Math.cos(seatAngleRad);
            const seatTubeTopY = bbY - (seatTubeCTLength) * Math.sin(seatAngleRad);

            // Calculate head tube bottom position
            // Head angle is measured from horizontal (72.25¬∞ clockwise from horizontal)
            const headAngleRad = (headAngle * Math.PI) / 180;
            const headTubeBottomX = headTubeTopX + (headTube * scale) * Math.cos(headAngleRad);
            const headTubeBottomY = headTubeTopY + (headTube * scale) * Math.sin(headAngleRad);

            // === STEP 6: BB, STACK, REACH + SEAT TUBE + HEAD TUBE + TOP TUBE + SEATPOST + SADDLE + HANDLEBARS ===
            
            // 1. Draw Bottom Bracket (origin point)
            const bbCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bbCircle.setAttribute('cx', bbX);
            bbCircle.setAttribute('cy', bbY);
            bbCircle.setAttribute('r', 8);
            bbCircle.setAttribute('fill', '#e74c3c');
            bbCircle.setAttribute('stroke', '#c0392b');
            bbCircle.setAttribute('stroke-width', '2');
            svg.appendChild(bbCircle);

            // 2. Draw Head Tube Top point
            const headTubeTopCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            headTubeTopCircle.setAttribute('cx', headTubeTopX);
            headTubeTopCircle.setAttribute('cy', headTubeTopY);
            headTubeTopCircle.setAttribute('r', 4);
            headTubeTopCircle.setAttribute('fill', '#3498db');
            headTubeTopCircle.setAttribute('stroke', '#2980b9');
            headTubeTopCircle.setAttribute('stroke-width', '1');
            svg.appendChild(headTubeTopCircle);

            // 3. Draw REACH measurement (horizontal) - OVERLAID on actual measurement
            const reachLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            reachLine.setAttribute('x1', bbX);
            reachLine.setAttribute('y1', bbY); // Direct from BB center
            reachLine.setAttribute('x2', headTubeTopX);
            reachLine.setAttribute('y2', bbY); // Horizontal line at BB level
            reachLine.setAttribute('stroke', '#e74c3c');
            reachLine.setAttribute('stroke-width', '3');
            reachLine.setAttribute('stroke-dasharray', '5,5'); // Dashed line
            svg.appendChild(reachLine);

            // REACH label - positioned above the line
            const reachText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            reachText.setAttribute('x', (bbX + headTubeTopX) / 2);
            reachText.setAttribute('y', bbY - 10);
            reachText.setAttribute('text-anchor', 'middle');
            reachText.setAttribute('class', 'measurement-text');
            reachText.setAttribute('font-weight', 'bold');
            reachText.textContent = `REACH: ${reach}mm`;
            svg.appendChild(reachText);

            // 4. Draw STACK measurement (vertical) - OVERLAID on actual measurement
            const stackLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stackLine.setAttribute('x1', bbX); // Direct from BB center
            stackLine.setAttribute('y1', bbY);
            stackLine.setAttribute('x2', bbX); // Vertical line at BB X position
            stackLine.setAttribute('y2', headTubeTopY);
            stackLine.setAttribute('stroke', '#3498db');
            stackLine.setAttribute('stroke-width', '3');
            stackLine.setAttribute('stroke-dasharray', '5,5'); // Dashed line
            svg.appendChild(stackLine);

            // STACK label - positioned beside the line
            const stackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            stackText.setAttribute('x', bbX + 15);
            stackText.setAttribute('y', (bbY + headTubeTopY) / 2);
            stackText.setAttribute('text-anchor', 'start');
            stackText.setAttribute('class', 'measurement-text');
            stackText.setAttribute('font-weight', 'bold');
            stackText.setAttribute('transform', `rotate(-90, ${bbX + 15}, ${(bbY + headTubeTopY) / 2})`);
            stackText.textContent = `STACK: ${stack}mm`;
            svg.appendChild(stackText);

            // 5. Draw SEAT TUBE (connects directly to BB)
            const seatTubeElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatTubeElement.setAttribute('x1', bbX);
            seatTubeElement.setAttribute('y1', bbY);
            seatTubeElement.setAttribute('x2', seatTubeTopX);
            seatTubeElement.setAttribute('y2', seatTubeTopY);
            seatTubeElement.setAttribute('stroke', '#34495e');
            seatTubeElement.setAttribute('stroke-width', '6');
            seatTubeElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(seatTubeElement);

            // Seat tube angle measurement line
            const seatTubeAngleLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatTubeAngleLine.setAttribute('x1', bbX);
            seatTubeAngleLine.setAttribute('y1', bbY);
            seatTubeAngleLine.setAttribute('x2', seatTubeTopX);
            seatTubeAngleLine.setAttribute('y2', seatTubeTopY);
            seatTubeAngleLine.setAttribute('stroke', '#e67e22');
            seatTubeAngleLine.setAttribute('stroke-width', '2');
            seatTubeAngleLine.setAttribute('stroke-dasharray', '3,3');
            svg.appendChild(seatTubeAngleLine);

            // Mark the C-T point (same as seat tube end)
            const seatTubeCTPoint = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            seatTubeCTPoint.setAttribute('cx', seatTubeTopX);
            seatTubeCTPoint.setAttribute('cy', seatTubeTopY);
            seatTubeCTPoint.setAttribute('r', 3);
            seatTubeCTPoint.setAttribute('fill', '#e67e22');
            svg.appendChild(seatTubeCTPoint);

            // Seat tube C-T measurement line (same as seat tube)
            const seatTubeCTMeasureLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatTubeCTMeasureLine.setAttribute('x1', bbX);
            seatTubeCTMeasureLine.setAttribute('y1', bbY);
            seatTubeCTMeasureLine.setAttribute('x2', seatTubeTopX);
            seatTubeCTMeasureLine.setAttribute('y2', seatTubeTopY);
            seatTubeCTMeasureLine.setAttribute('stroke', '#e67e22');
            seatTubeCTMeasureLine.setAttribute('stroke-width', '3');
            seatTubeCTMeasureLine.setAttribute('stroke-dasharray', '5,5');
            svg.appendChild(seatTubeCTMeasureLine);

            // Seat tube C-T label
            const seatTubeCTText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            seatTubeCTText.setAttribute('x', seatTubeTopX - 60);
            seatTubeCTText.setAttribute('y', (bbY + seatTubeTopY) / 2);
            seatTubeCTText.setAttribute('class', 'measurement-text');
            seatTubeCTText.setAttribute('font-weight', 'bold');
            seatTubeCTText.textContent = `SEAT TUBE C-T: ${seatTube}mm`;
            svg.appendChild(seatTubeCTText);

            // Seat angle label
            const seatAngleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            seatAngleText.setAttribute('x', bbX - 80);
            seatAngleText.setAttribute('y', bbY - 20);
            seatAngleText.setAttribute('class', 'measurement-text');
            seatAngleText.setAttribute('font-size', '12px');
            seatAngleText.textContent = `SEAT ANGLE: ${seatAngle}¬∞`;
            svg.appendChild(seatAngleText);

            // 6. Draw HEAD TUBE
            const headTubeElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            headTubeElement.setAttribute('x1', headTubeTopX);
            headTubeElement.setAttribute('y1', headTubeTopY);
            headTubeElement.setAttribute('x2', headTubeBottomX);
            headTubeElement.setAttribute('y2', headTubeBottomY);
            headTubeElement.setAttribute('stroke', '#34495e');
            headTubeElement.setAttribute('stroke-width', '6');
            headTubeElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(headTubeElement);

            // Head tube measurement line
            const headTubeMeasurementLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            headTubeMeasurementLine.setAttribute('x1', headTubeTopX);
            headTubeMeasurementLine.setAttribute('y1', headTubeTopY);
            headTubeMeasurementLine.setAttribute('x2', headTubeBottomX);
            headTubeMeasurementLine.setAttribute('y2', headTubeBottomY);
            headTubeMeasurementLine.setAttribute('stroke', '#9b59b6');
            headTubeMeasurementLine.setAttribute('stroke-width', '2');
            headTubeMeasurementLine.setAttribute('stroke-dasharray', '3,3');
            svg.appendChild(headTubeMeasurementLine);

            // Head tube length label
            const headTubeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            headTubeText.setAttribute('x', headTubeBottomX + 15);
            headTubeText.setAttribute('y', (headTubeTopY + headTubeBottomY) / 2);
            headTubeText.setAttribute('class', 'measurement-text');
            headTubeText.setAttribute('font-weight', 'bold');
            headTubeText.textContent = `HEAD TUBE: ${headTube}mm`;
            svg.appendChild(headTubeText);

            // Head angle label
            const headAngleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            headAngleText.setAttribute('x', headTubeTopX + 20);
            headAngleText.setAttribute('y', headTubeTopY - 5);
            headAngleText.setAttribute('class', 'measurement-text');
            headAngleText.setAttribute('font-size', '12px');
            headAngleText.textContent = `HEAD ANGLE: ${headAngle}¬∞`;
            svg.appendChild(headAngleText);

            // 7. Draw TOP TUBE (effective) - connects seat tube top to head tube top
            const topTubeElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            topTubeElement.setAttribute('x1', seatTubeTopX);
            topTubeElement.setAttribute('y1', seatTubeTopY);
            topTubeElement.setAttribute('x2', headTubeTopX);
            topTubeElement.setAttribute('y2', headTubeTopY);
            topTubeElement.setAttribute('stroke', '#34495e');
            topTubeElement.setAttribute('stroke-width', '6');
            topTubeElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(topTubeElement);



            // 6. Add labels for the points
            const bbLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            bbLabel.setAttribute('x', bbX);
            bbLabel.setAttribute('y', bbY + 25);
            bbLabel.setAttribute('text-anchor', 'middle');
            bbLabel.setAttribute('class', 'measurement-text');
            bbLabel.setAttribute('font-size', '12px');
            bbLabel.textContent = 'BB CENTER';
            svg.appendChild(bbLabel);

            const headLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            headLabel.setAttribute('x', headTubeTopX);
            headLabel.setAttribute('y', headTubeTopY - 10);
            headLabel.setAttribute('text-anchor', 'middle');
            headLabel.setAttribute('class', 'measurement-text');
            headLabel.setAttribute('font-size', '12px');
            headLabel.textContent = 'HEAD TUBE TOP';
            svg.appendChild(headLabel);

            // === SPACERS ===
            
            // Get spacer parameters
            const spacerDistance = params.spacerHeight || 20; // mm
            
            // Calculate spacer top position (extending from head tube top along head tube angle)
            const spacerTopX = headTubeTopX - (spacerDistance * scale) * Math.cos(headAngleRad);
            const spacerTopY = headTubeTopY - (spacerDistance * scale) * Math.sin(headAngleRad);
            
            // Draw SPACERS (line extending from head tube top)
            const spacerElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            spacerElement.setAttribute('x1', headTubeTopX);
            spacerElement.setAttribute('y1', headTubeTopY);
            spacerElement.setAttribute('x2', spacerTopX);
            spacerElement.setAttribute('y2', spacerTopY);
            spacerElement.setAttribute('stroke', '#f39c12');
            spacerElement.setAttribute('stroke-width', '5');
            spacerElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(spacerElement);
            
            // Mark spacer top
            const spacerTopCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            spacerTopCircle.setAttribute('cx', spacerTopX);
            spacerTopCircle.setAttribute('cy', spacerTopY);
            spacerTopCircle.setAttribute('r', 3);
            spacerTopCircle.setAttribute('fill', '#f39c12');
            svg.appendChild(spacerTopCircle);
            
            // Spacer distance label
            const spacerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            spacerText.setAttribute('x', (headTubeTopX + spacerTopX) / 2 + 15);
            spacerText.setAttribute('y', (headTubeTopY + spacerTopY) / 2);
            spacerText.setAttribute('class', 'measurement-text');
            spacerText.setAttribute('font-size', '12px');
            spacerText.textContent = `SPACERS: ${spacerDistance}mm`;
            svg.appendChild(spacerText);

            // === STEM HEIGHT (constant 40mm component) ===
            
            const stemHeight = 40; // mm - constant stem body height
            
            // Calculate stem body top position (extending from spacer top along head tube angle)
            const stemBodyTopX = spacerTopX - (stemHeight * scale) * Math.cos(headAngleRad);
            const stemBodyTopY = spacerTopY - (stemHeight * scale) * Math.sin(headAngleRad);
            
            // Draw STEM HEIGHT (line extending from spacer top)
            const stemHeightElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stemHeightElement.setAttribute('x1', spacerTopX);
            stemHeightElement.setAttribute('y1', spacerTopY);
            stemHeightElement.setAttribute('x2', stemBodyTopX);
            stemHeightElement.setAttribute('y2', stemBodyTopY);
            stemHeightElement.setAttribute('stroke', '#34495e');
            stemHeightElement.setAttribute('stroke-width', '8');
            stemHeightElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(stemHeightElement);
            
            // Mark stem body top
            const stemBodyTopCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            stemBodyTopCircle.setAttribute('cx', stemBodyTopX);
            stemBodyTopCircle.setAttribute('cy', stemBodyTopY);
            stemBodyTopCircle.setAttribute('r', 4);
            stemBodyTopCircle.setAttribute('fill', '#34495e');
            svg.appendChild(stemBodyTopCircle);
            
            // Stem height label
            const stemHeightText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            stemHeightText.setAttribute('x', (spacerTopX + stemBodyTopX) / 2 + 20);
            stemHeightText.setAttribute('y', (spacerTopY + stemBodyTopY) / 2);
            stemHeightText.setAttribute('class', 'measurement-text');
            stemHeightText.setAttribute('font-size', '12px');
            stemHeightText.textContent = `STEM HEIGHT: ${stemHeight}mm`;
            svg.appendChild(stemHeightText);

            // === STEM (forward extension) ===
            
            // Get stem parameters
            const stemLength = params.stemLength || 90; // mm
            const stemAngle = params.stemAngle || -6; // degrees, offset from perpendicular to spacers
            
            // Calculate stem angle: perpendicular to head tube + stem angle offset
            // Perpendicular to head tube (forward direction): head tube angle - 90¬∞
            // Negative stem angle should point downwards, so we subtract the angle
            const stemAngleRad = (headAngle - 90 - stemAngle) * (Math.PI / 180);
            
            // Calculate stem end position (extending from stem body top)
            const stemEndX = stemBodyTopX + (stemLength * scale) * Math.cos(stemAngleRad);
            const stemEndY = stemBodyTopY + (stemLength * scale) * Math.sin(stemAngleRad);
            
            // Draw STEM (line extending from stem body top)
            const stemElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            stemElement.setAttribute('x1', stemBodyTopX);
            stemElement.setAttribute('y1', stemBodyTopY);
            stemElement.setAttribute('x2', stemEndX);
            stemElement.setAttribute('y2', stemEndY);
            stemElement.setAttribute('stroke', '#2c3e50');
            stemElement.setAttribute('stroke-width', '6');
            stemElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(stemElement);
            
            // Mark stem end (where handlebars attach)
            const stemEndCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            stemEndCircle.setAttribute('cx', stemEndX);
            stemEndCircle.setAttribute('cy', stemEndY);
            stemEndCircle.setAttribute('r', 4);
            stemEndCircle.setAttribute('fill', '#2c3e50');
            svg.appendChild(stemEndCircle);
            
            // Stem length label
            const stemLengthText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            stemLengthText.setAttribute('x', (stemBodyTopX + stemEndX) / 2 + 15);
            stemLengthText.setAttribute('y', (stemBodyTopY + stemEndY) / 2 - 5);
            stemLengthText.setAttribute('class', 'measurement-text');
            stemLengthText.setAttribute('font-size', '12px');
            stemLengthText.textContent = `STEM: ${stemLength}mm`;
            svg.appendChild(stemLengthText);
            
            // Stem angle label
            const stemAngleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            stemAngleText.setAttribute('x', (stemBodyTopX + stemEndX) / 2 + 15);
            stemAngleText.setAttribute('y', (stemBodyTopY + stemEndY) / 2 + 10);
            stemAngleText.setAttribute('class', 'measurement-text');
            stemAngleText.setAttribute('font-size', '10px');
            stemAngleText.textContent = `${stemAngle}¬∞ from ‚ä•`;
            svg.appendChild(stemAngleText);

            // === BIKE FIT COMPONENTS ===
            
            // Get bike fit parameters
            const saddleHeight = params.saddleHeight || 760;
            const saddleLength = params.saddleLength || 250;
            const seatpostSetback = params.seatpostSetback || 25;
            const saddleTipToBB = params.saddleTipToBB || 91;
            const saddleRailPosition = params.saddleRailPosition || 0;
            const saddleToBarHeight = params.saddleToBarHeight || 64;
            const saddleTipToBarCenter = params.saddleTipToBarCenter || 550;
            
            // Calculate seatpost length: saddleHeight - seatTube
            const seatpostLength = saddleHeight - seatTube;
            
            // Calculate seatpost shaft top position (along seat tube, no setback yet)
            const seatpostShaftTopX = bbX - ((seatTube + seatpostLength) * scale) * Math.cos(seatAngleRad);
            const seatpostShaftTopY = bbY - ((seatTube + seatpostLength) * scale) * Math.sin(seatAngleRad);
            
            // Calculate seatpost head position (with setback - perpendicular to seat tube)
            const setbackX = -(seatpostSetback * scale) * Math.sin(seatAngleRad); // Perpendicular to seat tube
            const setbackY = -(seatpostSetback * scale) * Math.cos(seatAngleRad); // Perpendicular to seat tube
            const seatpostHeadX = seatpostShaftTopX + setbackX;
            const seatpostHeadY = seatpostShaftTopY + setbackY;

            // 8. Draw SEATPOST SHAFT (from seat tube top to seatpost shaft top)
            const seatpostShaftElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatpostShaftElement.setAttribute('x1', seatTubeTopX);
            seatpostShaftElement.setAttribute('y1', seatTubeTopY);
            seatpostShaftElement.setAttribute('x2', seatpostShaftTopX);
            seatpostShaftElement.setAttribute('y2', seatpostShaftTopY);
            seatpostShaftElement.setAttribute('stroke', '#2c3e50');
            seatpostShaftElement.setAttribute('stroke-width', '4');
            seatpostShaftElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(seatpostShaftElement);

            // 8b. Draw SEATPOST HEAD (setback portion)
            const seatpostHeadElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            seatpostHeadElement.setAttribute('x1', seatpostShaftTopX);
            seatpostHeadElement.setAttribute('y1', seatpostShaftTopY);
            seatpostHeadElement.setAttribute('x2', seatpostHeadX);
            seatpostHeadElement.setAttribute('y2', seatpostHeadY);
            seatpostHeadElement.setAttribute('stroke', '#2c3e50');
            seatpostHeadElement.setAttribute('stroke-width', '4');
            seatpostHeadElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(seatpostHeadElement);

            // 9. Draw SADDLE (horizontal line with rail adjustment)
            const saddleLengthScaled = (saddleLength * scale) / 2; // Half length for centering
            const saddleRailAdjustment = saddleRailPosition * scale; // Fore/aft adjustment on rails
            
            // Saddle position (centered on seatpost head + rail adjustment)
            const saddleCenterX = seatpostHeadX + saddleRailAdjustment;
            const saddleCenterY = seatpostHeadY;
            
            const saddleLeftX = saddleCenterX - saddleLengthScaled;
            const saddleRightX = saddleCenterX + saddleLengthScaled;
            
            const saddleElement = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            saddleElement.setAttribute('x1', saddleLeftX);
            saddleElement.setAttribute('y1', saddleCenterY);
            saddleElement.setAttribute('x2', saddleRightX);
            saddleElement.setAttribute('y2', saddleCenterY);
            saddleElement.setAttribute('stroke', '#8e44ad');
            saddleElement.setAttribute('stroke-width', '6');
            saddleElement.setAttribute('stroke-linecap', 'round');
            svg.appendChild(saddleElement);
            
            // Mark saddle tip (nose)
            const saddleTipX = saddleRightX; // Right end is the tip/nose
            const saddleTipY = saddleCenterY;
            
            const saddleTipCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            saddleTipCircle.setAttribute('cx', saddleTipX);
            saddleTipCircle.setAttribute('cy', saddleTipY);
            saddleTipCircle.setAttribute('r', 3);
            saddleTipCircle.setAttribute('fill', '#e74c3c');
            svg.appendChild(saddleTipCircle);

            // === HANDLEBARS ===
            
            // Handlebars are positioned at the stem end (from optimization)
            // The stem end position was calculated to match the fit requirements exactly
            const handlebarX = stemEndX;
            const handlebarY = stemEndY;
            
            // 10. Draw HANDLEBARS (circle - side view)
            const handlebarCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            handlebarCircle.setAttribute('cx', handlebarX);
            handlebarCircle.setAttribute('cy', handlebarY);
            handlebarCircle.setAttribute('r', 8);
            handlebarCircle.setAttribute('fill', '#16a085');
            handlebarCircle.setAttribute('stroke', '#138d75');
            handlebarCircle.setAttribute('stroke-width', '2');
            svg.appendChild(handlebarCircle);

            // Saddle height measurement (BB to saddle level, straight up seatpost shaft)
            const saddleHeightLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            saddleHeightLine.setAttribute('x1', bbX);
            saddleHeightLine.setAttribute('y1', bbY);
            saddleHeightLine.setAttribute('x2', bbX - (saddleHeight * scale) * Math.cos(seatAngleRad));
            saddleHeightLine.setAttribute('y2', bbY - (saddleHeight * scale) * Math.sin(seatAngleRad));
            saddleHeightLine.setAttribute('stroke', '#f39c12');
            saddleHeightLine.setAttribute('stroke-width', '2');
            saddleHeightLine.setAttribute('stroke-dasharray', '4,4');
            svg.appendChild(saddleHeightLine);

            // Tip to BB measurement (HORIZONTAL measurement) - THE KEY MEASUREMENT
            const tipToBBLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tipToBBLine.setAttribute('x1', bbX);
            tipToBBLine.setAttribute('y1', bbY);
            tipToBBLine.setAttribute('x2', saddleTipX);
            tipToBBLine.setAttribute('y2', bbY); // Same Y level as BB (horizontal line)
            tipToBBLine.setAttribute('stroke', '#e74c3c');
            tipToBBLine.setAttribute('stroke-width', '3');
            tipToBBLine.setAttribute('stroke-dasharray', '6,6');
            svg.appendChild(tipToBBLine);

            // Saddle height label (positioned along seatpost shaft line)
            const saddleHeightEndX = bbX - (saddleHeight * scale) * Math.cos(seatAngleRad);
            const saddleHeightEndY = bbY - (saddleHeight * scale) * Math.sin(seatAngleRad);
            const saddleHeightText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            saddleHeightText.setAttribute('x', (bbX + saddleHeightEndX) / 2 - 40);
            saddleHeightText.setAttribute('y', (bbY + saddleHeightEndY) / 2);
            saddleHeightText.setAttribute('class', 'measurement-text');
            saddleHeightText.setAttribute('font-weight', 'bold');
            saddleHeightText.textContent = `SADDLE HEIGHT: ${saddleHeight}mm`;
            svg.appendChild(saddleHeightText);

            // Tip-to-BB measurement label (positioned along horizontal line)
            const tipToBBText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            tipToBBText.setAttribute('x', (bbX + saddleTipX) / 2);
            tipToBBText.setAttribute('y', bbY - 15); // Above the horizontal line
            tipToBBText.setAttribute('class', 'measurement-text');
            tipToBBText.setAttribute('font-weight', 'bold');
            tipToBBText.setAttribute('font-size', '12px');
            tipToBBText.setAttribute('text-anchor', 'middle');
            tipToBBText.textContent = `TIP-TO-BB: ${saddleTipToBB}mm`;
            svg.appendChild(tipToBBText);

            // Seatpost setback label
            const setbackText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            setbackText.setAttribute('x', seatpostHeadX + 10);
            setbackText.setAttribute('y', seatpostHeadY - 10);
            setbackText.setAttribute('class', 'measurement-text');
            setbackText.setAttribute('font-size', '12px');
            setbackText.textContent = `SETBACK: ${Math.round(seatpostSetback)}mm`;
            svg.appendChild(setbackText);

            // Saddle-to-bar height measurement (vertical line)
            const saddleToBarLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            saddleToBarLine.setAttribute('x1', saddleCenterX - 30); // Offset to avoid cluttering
            saddleToBarLine.setAttribute('y1', saddleCenterY);
            saddleToBarLine.setAttribute('x2', saddleCenterX - 30);
            saddleToBarLine.setAttribute('y2', handlebarY);
            saddleToBarLine.setAttribute('stroke', '#9b59b6');
            saddleToBarLine.setAttribute('stroke-width', '2');
            saddleToBarLine.setAttribute('stroke-dasharray', '4,4');
            svg.appendChild(saddleToBarLine);

            // Saddle-to-bar height label
            const saddleToBarText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            saddleToBarText.setAttribute('x', saddleCenterX - 90);
            saddleToBarText.setAttribute('y', (saddleCenterY + handlebarY) / 2);
            saddleToBarText.setAttribute('class', 'measurement-text');
            saddleToBarText.setAttribute('font-weight', 'bold');
            saddleToBarText.setAttribute('font-size', '12px');
            saddleToBarText.setAttribute('transform', `rotate(-90, ${saddleCenterX - 90}, ${(saddleCenterY + handlebarY) / 2})`);
            saddleToBarText.textContent = `SADDLE DROP: ${saddleToBarHeight}mm`;
            svg.appendChild(saddleToBarText);

            // Tip-to-bar center measurement (diagonal line) - THE KEY BIKE FIT MEASUREMENT
            const tipToBarLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tipToBarLine.setAttribute('x1', saddleTipX);
            tipToBarLine.setAttribute('y1', saddleTipY);
            tipToBarLine.setAttribute('x2', handlebarX);
            tipToBarLine.setAttribute('y2', handlebarY);
            tipToBarLine.setAttribute('stroke', '#27ae60');
            tipToBarLine.setAttribute('stroke-width', '3');
            tipToBarLine.setAttribute('stroke-dasharray', '8,8');
            svg.appendChild(tipToBarLine);

            // Tip-to-bar center label
            const tipToBarText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            tipToBarText.setAttribute('x', (saddleTipX + handlebarX) / 2);
            tipToBarText.setAttribute('y', (saddleTipY + handlebarY) / 2 - 10);
            tipToBarText.setAttribute('class', 'measurement-text');
            tipToBarText.setAttribute('font-weight', 'bold');
            tipToBarText.setAttribute('font-size', '12px');
            tipToBarText.setAttribute('text-anchor', 'middle');
            tipToBarText.textContent = `TIP-TO-BAR: ${saddleTipToBarCenter}mm`;
            svg.appendChild(tipToBarText);
        }





        // Load test data for 54T Strael
        function loadStrael54T() {
            // Frame geometry
            document.getElementById('reach').value = 378;
            document.getElementById('stack').value = 580;
            document.getElementById('seatTube').value = 536;
            document.getElementById('headAngle').value = 72.25;
            document.getElementById('seatAngle').value = 73.75;
            document.getElementById('headTube').value = 157;

            // Bike fit (optimal values)
            document.getElementById('saddleHeight').value = 760;
            document.getElementById('saddleTipToBB').value = 91;
            document.getElementById('saddleToBarHeight').value = 64;
            document.getElementById('saddleTipToBarCenter').value = 550;

            // Calculate and show test results
            calculateBikeFit();
            
            const stemResult = parseFloat(document.getElementById('stemLength').textContent);
            const seatpostResult = parseFloat(document.getElementById('seatpostSetback').textContent);
            
            let testMessage = `Test Results:<br>`;
            testMessage += `Stem: ${Math.round(stemResult)}mm (Target: ~90mm) `;
            testMessage += Math.abs(stemResult - 90) < 15 ? '<span class="success">‚úÖ</span>' : '<span class="warning">‚ùå</span>';
            testMessage += `<br>Seatpost: ${seatpostResult.toFixed(1)}mm (Target: ~25mm) `;
            testMessage += Math.abs(seatpostResult - 25) < 10 ? '<span class="success">‚úÖ</span>' : '<span class="warning">‚ùå</span>';
            
            document.getElementById('testResults').innerHTML = testMessage;
        }

        // Add event listeners to all inputs
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculateBikeFit);
            });
        });
    </script>
</body>
</html>